---
- name: Ensure dependencies are installed.
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - gnupg2
    state: present

- name: "Remove old key"
  ansible.builtin.apt_key:
    id: '9DC858229FC7DD38854AE2D88D81803C0EBFCD88'
    state: "absent"

- name: "Remove old source.d"
  ansible.builtin.file:
    path: "/etc/apt/sources.list.d/download_docker_com_linux_ubuntu.list"
    state: "absent"

- name: "Docker Repo"
  ansible.builtin.deb822_repository:
    name: "docker"
    types: "deb"
    uris: "https://download.docker.com/linux/{{ ansible_distribution | lower }}"
    suites: "{{ ansible_facts['distribution_release'] }}"
    components:
      - "{{ docker_apt_release_channel }}"
    architectures: "{{ docker_apt_arch }}"
    signed_by: "{{ docker_apt_gpg_key }}"

- name: Ensure curl is present (on older systems without SNI).
  package: name=curl state=present
  when: add_repository_key is failed

- name: Add Docker apt key (alternative for older systems without SNI).
  shell: >
    curl -sSL {{ docker_apt_gpg_key }} | sudo apt-key add -
  when: add_repository_key is failed

- name: Add Docker repository.
  apt_repository:
    repo: "{{ docker_apt_repository }}"
    state: present
    update_cache: true
